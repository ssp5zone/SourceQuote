# Deploying on OpenShift RedHat

## Requirement

1. Git Client.
2. Putty

* I am lazy to install ruby, otherwise you could use RedHat client too.

## Generating an SSH key for the application

1. Create a key with git (instead of puttygen) so that git is happy.

2. In `git bash here` 

	1. Goto path C:\...<user-name>\.ssh\
	2. Type `ssh-keygen` (Don't give a passphrase). This would generate 2 files ida_rsa and ida_rsa.pub.
	3. Use this (.pub file contents) as your redhat application key. 
	4. You can have multiple keys - one from puttygen and one from ssh-keygen.

3. To connect to the remote via ssh terminal (PuTTy), you require a private key too. So, now generate another key (Save as private key) using `puttygen.exe`. Name this file as `default.ppk`. Now you can use this for authentication in putty. Ref: [PuTTy connection to RedHat](https://developers.openshift.com/managing-your-applications/remote-connection.html#common-commands)

4. Connecting from Android,

	1. Get [Termux](https://play.google.com/store/apps/details?id=com.termux&hl=en)
	2. Run `apt-get update` first.
	3. Install OpenSSH - `apt install openssh`
	4. Download the keys (Public keys. Private won't work.).
	5. Create folder `~/.ssh/authorized_keys`. (First check if `cd ~/.ssh` exists)
	6. Copy the keys to this folder.
	7. Run the command `ssh [key]@[domain]-initdev.rhcloud.com`.


## Adding existing git repo to redhat:

The approach to choose here is to clone your other git repo (ex. on bitbucket) to your local machine:

```bash
git clone <bitbucket-repo-url>
```

Your local clone has then your other repo (bitbucket etc.) as remote repo. Your remote repo is stored with the alias "origin" (the default alias used by git if you clone). You then add the openshift repo as remote to your clone. You do that while explicitly using an alias for the remote repo you add - I'm using "openshift" as alias here:

```bash
git remote add openshift -f <openshift-git-repo-url>
```

In order to then be able to push the code from your local git repo to openshift you first have to merge your openshift repo with your local bitbucket clone. You do that by issuing locally:

```bash
git merge openshift/master -s recursive -X ours
```

With this command you tell git to merge the master branch in the openshift git repo with your local git repo. You tell it to merge using the recursive merging strategy and to choose your ("ours") version when there are conflicts.

Once the merge is executed you're ready to push your git repo to openshift. You do that by doing:

```bash
git push openshift HEAD
```

That's it. You have added a remote branch that you could seperatly track - independent of your dev build. Whenever you feel the code is stable you can push it to production.

**_Use the above cmd everytime you need to push the code to production (LIVE)._**

##  Key Points

1. Before pushing your code, take a look at the default code generated by RedHat. It has some useful pointers.

2. All your npm `devDependencies` (--save-dev) will not be installed by the Server. Hence, remmember to give the necessary as `dependencies` (--save).

3. In your package.json, add a "start" info. This will ensure that the server is automatically started anytime you have pushed the code. (No need of PuTTy).
    ```json
    {
	    "main": "index.js",
	    "scripts": 
	    {
	        "postinstall": "bower install || HOME=$OPENSHIFT_REPO_DIR bower install",
	        "start": "node index.js"
	    }
    }
    ```
    
4. If `bower install` is giving trouble, install it globally in putty.
    ```bash
    npm install bower -g
    ```
    
5. For importing mysqldump, use the PuTTy (SSH Terminal), navigate to path containing the dump e.g. `app-deployments\current\repo\docs\sql_dump\` and execute,
    ```bash
    mysql xnode < dump.sql
    ```
    
6. If mysql tell you about no such database, manuall create it using Termial cmd line.
7. To view the application logs,
    ```bash
    cd $OPENSHIFT_LOG_DIR
    cat nodejs.log
    ```
    
8. To manually check status, start or stop the server,
    ```bash
    ctl_app status
    ctl_app start
    ctl_app stop
    ```
    
9. Add the following as server variables in your app, so that it starts correctly on both server and local machine.
    ```javascript
    var server_port = process.env.OPENSHIFT_NODEJS_PORT || 8787;
    var server_ip_address = process.env.OPENSHIFT_NODEJS_IP || '127.0.0.1';
    ```
    
10. Do the same for DB connection variables as well.
    ```javascript
    var dbConfig={};
    dbConfig.host = process.env.OPENSHIFT_MYSQL_DB_HOST || "localhost";
    dbConfig.user = process.env.OPENSHIFT_MYSQL_DB_USERNAME || "root";
    dbConfig.password = process.env.OPENSHIFT_MYSQL_DB_PASSWORD || "root";
    dbConfig.database = process.env.OPENSHIFT_MYSQL_DB_NAME || "local_db_name";
    ...
    require("mysql").createConnection(this.dbConfig);
    ```
